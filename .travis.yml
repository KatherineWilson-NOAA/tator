os: linux
arch: amd64
dist: focal
language: generic
services:
- docker
vm:
  size: x-large

addons:
  apt:
    update: true
    packages:
    - python3
    - python3-pip

jobs:
  include:
  - stage: build docker images
    install:
    - cp helm/tator/values-microk8s.yaml helm/tator/values.yaml
    - sed -i "s/localhost:32000/$DOCKER_REGISTRY/g" helm/tator/values.yaml
    - cat helm/tator/values.yaml
    - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
    - pip3 install setuptools wheel sphinx-rtd-theme recommonmark mako progressbar2 pyyaml
    - npm install
    script:
    - make main/version.py
    - make python-bindings
    - make postgis-image
    - make client-image
  - stage: install and test
    install:
    - ./install.sh
    script:
    - make testinit
    - make test
    - cp -r scripts/packages/tator-py/test .
    - cp -r scripts/packages/tator-py/examples .
    - export GUNICORN_POD=$(kubectl get pod -l app=gunicorn -o name | head -n 1 | sed
      's/pod\///')
    - export TOKEN=$(kubectl exec -it $GUNICORN_POD -- python3 manage.py shell --command="from rest_framework.authtoken.models import Token; from main.models import User; token, _ = Token.objects.get_or_create(user=User.objects.first()); print(token)")
    - export TOKEN=$(echo $TOKEN | tr -d '\r')
    - pytest test --host=http://$HOST_IP --token=$TOKEN

env:
  global:
  - DOCKER_REGISTRY=cvisionai
  - secure: "S3SgU7Gw3SD5fY68DKPTqiuBK6KzNe11g4R16Sl2MhhyGLZzFEbmJXtSgCihtXE8fHiwuegmAma7qioEyoAN+e1i+4zzc9WepKDGBquQninhuKCDx1gCdlqAk4vEjtv/xu3bgjIO0JUst5CgPBloa5fRUmP6du87xcNzZwJA0lDTXHaMqnjhK8OnS8xQJMu5zeh7I3hPXKHeS8aTvpTI5Eww2O2rzKL+cAKMUyjeBC5KXKFN6pyChmrj73Wi+u6lmhJBGgX7TJ09bScnet+XbvAPuC1rIGx/GKzqaXyqsd1ZgbuIk9LUTY0flqhUkNC1hryAFCyxTXMw45VJAEY6gk+BYmIZDxdMD5y0ZimIgDniiRPPAPL6e1nf6DtLfON2wnoY6YC/X/DY9Pr7CWeLOHCtARnyWiapSIj8XkfyaWxvKR8cDdes1E5m29ogvqWscfTdV3wLpC9M74TtxR4S7JoMGIZrki13A1ykYkqLVwOL8JvEHSeyLlCAaCE83IqreGhXRcPjUY6x/dSOJWdIbCcovLhI5vCr10upmWT+bd7NFXim86Hbm4XC0ICmq0diW8zdk/+zL0bA1J/AB5X8Me5ChGEB+HdCC6ok38wzRnVD7UfSxL2y6GkzMxzoBg5cF//iU9RXhGoacmDQ7k9uPagVmKpRGuTp0Sy4n8mLvYc="
  - secure: "nLr0ULiK2RUfL6AVd1gbvXXbya5tzcaLUlpwoM23vqWfZGORU5MEWoDol/czubbxUIlXPttGMt76yGoFEw+uDZz9M1UtHSz5YiXNHN6EjQZ0PFT9lakkcg3vFMPAe8w4nrCL3+M2YY9BcOnddz1niB0w0KmarOwM8do6DDR8Kr8qRsnO4CVvhqqvNBbKSlFZJdCQu/sgRtWp/3wXA+rWgUJN27P+qh2o8nkDbBo1tcjVmEwZLWq8t3PGckwo23V4KMZIs91w5AcLcuWZolnafuyaWGnoGRKnPhnqRn3Z/fqG9rwNwOnDVd06LOmbaWX7pjUDOEwBnpVu4W6JwG+OVE89BstoGqU/74Y5E/5cTT8YjS9s3+otut5YfFQvtSDVZXW+sPn4ES0LrvjOTjk85U/Gtl2Hup+rqTJaJh38ktt0wA51oGvEWSD+WT2hiq8iFAnGHUClQdjEa4JT3dZN4MJ6qicHe8JKwjWMdn0SqeIYcJos5Qerv1jgfLO/a33rsAU7E+zKeK/+E5n1hXrxU32CP5ZaOIkbuxuZ9ROygAokmIFpw1QIuN3+y+P+/ZO25/lqgLBirQ/YcrBePRCjFbiWSrtEQfOtpPBjr0n2/DAHaWSrnMlkvT7MCobvdzTfOT5NW1ny3VrcnZ8CIuZIw0w53LVVG4U6p2Nbk3+uvo4="
  - secure: "XjhMmIH6rOym9wL7D1+G0NERQ1J2NdmyiY+pLWNEbUk9bEP/XcrMvQ6oeAroGb/hguLuoKEKHOYYXo+BuUcMLHxvRD0eH6SUL49/WdNhErypDin1lCd+6pegXaYrAlOvMPhfGAL7857AqDyVgTZwFOi6FF/9zUsyqsaqy4VMCjM16kqysvZur3sh/QpZAUol1jWPZRoHq2djruGLX/t+R4tu+Dp4wvIuiat0IRh7o7PB3yvnQwB8OMJ1I7VHLeSKxUKgUMDOq8vaCQqq19QW5GIoQcicoRF4Smtoh/xyfmygKM+JxVOZUVUXiPzLVzdyndpz1JR3zSRa30L8P3aX9QQY1dwZ9rOtjjE7baOV0tQoFCy0HrlXBoY2ppFvgO9SGleaX+OK+6tBBS/eWTvpoCXZwyJc3+F9fyYNZWY0PcM4iWrLjPNJjeQh4RkPX/PZzFsAKkXkVO0/rwLt63VA7Wbr1I2ssX+tN1oo5rfAGK97cjWRrTlRtncExtwWJqGHE0+Qs6kRjhs6rIPINC0RFV6K16Z1WDaAbEHL2eftzP/nuRA3j2gqsvDMq4gF9jgKlF+IX2F4QGdJIS4fV9HRh0lw+YH5XsNRkRDzMraahVKd3/GAkYYb2vAkwjIUMq1wyce7dt7GNkLZc+TNrb5S1Kaxowsjm/is3AQRpFtPUKM="
  - secure: "h4CSRbN1BWi/aLYCnNHHg/y+XEBJYgxoHur4bOAiowTZ+79J7GWIwNOvp6YKhKbXvbjHy5LUcwKzYF6hlP+mn/8WDiymFFBL2ba88lELIM4vuoQ0nCf2P7s/8HjZaV09TKTk59/MQZae+BO8ndcBTrsqhHPl87nKKC9gJ+dr2cTNB/ObJDPRxa/RrfqmeDBWWNp8ggMD1s9HGJhF9MFiuK/+HJQu5Jm68W8DONF3iiqdDbFSMkOBonZ/fpdbutx9qhTplU/GRhK2Rx/FXl0+HRhneDVorv/fGwNpEglMPUPpY0dqI02E6v44NDz0GtpjdjYND0FjVlLAsOtZYemsPyGLoVfvQ58tfv7eNVwbiclde/HpGF8Bc7ZPvAhpp3W7bvunRmin3cTJtfIPL4cYh5nwWWqrfOrTU/Rqs+o3twcVa9EHE2RAtUcteJyNSZ9d/R8hgus6Pkew64VwXNLSnwbVZWzcDaQXToj2njFq8+GNCAq1jgMRHL5HeOi8fm3TYZyamNgHBYtjrx5d0Uky2YQQMa2YndFRrtCphUz7uKUd+D7pupA/1DFrr3VOZAK6cLq6vEAsgr1AICeBSORfdVz05Odo8fWPDdAYG550Wwp5G5+493BfAqJ9odHo3u/zkNQG+oOzd5A6U+RsW1PItWGVe+Y/H9v49asaexDap4M="
  - secure: "EsV94e9jVOTeDTjOxO9m4dNBuVwV7YqTMqyHFaQ/D+Py7a8wPuV3mkJP/RkuapC3oic9bgdGMW1PAoTJtQSoOd6R8Svc7wSsFRpN2vV6nqDwJ36iWsO8bBCCKf0lNljJv2ri6zsRIRyVXdikWb4OAzVveND+NBMbSm7pOvwITCLhc2GFiFCQytG7qYCuHj71BLhEtBl51d6Bt9c8WGdaTITM1aSJbNZKIKXcKRtA7SvdgzvhfieCcxDZSOD7tuSeHBJ1Lp+uImLGKkwLl61em+mKXVdE2/H285VoSYeF02QC/AL8xA61zf2JjhVMoEsLLirpyeWOG6oizE7e9T7YlxZI8DAUotQYS8u8LSCMjnP66wbVxl8mtvYQwfkfrDoQt0qMEEPaJuljip80G26yQOEjdoSkhhojdBKcGaqDjrWOJxTvkX9hVd2U0Ik1Vpd/E9ask1NglEVJ7qi71CJg/Ku9BHZ7k5bs2dU8zGyWuqUvbcUgExcgGc2wWGc9T8RxKRx44v5QCglkYrwg6A7XHk5LlZD0wHL0PoRP7z1e3BHE41teHTs+M+N3nVfwsO7eweHiGo1KKnH4Hq1Z4mdlJoKFHgcIteSdYniAOpCebk7HCkpsonuVr1BKgnfF9DcA4+IioVw917C8BnQcSZkpQew9wlySdEhF2kAB0wwUiM8="
